<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
<script>
// Robust category filtering that works even if Quarto's list JS fails or isn't loaded
(function () {
  const parseCategoryList = (str = "") =>
    str
      .split(",")
      .map((c) => c.trim())
      .filter(Boolean);

  const items = () => Array.from(document.querySelectorAll(".quarto-listing .list > li.project"));

  const setActiveChip = (category) => {
    const safeCategory =
      typeof CSS !== "undefined" && CSS.escape ? CSS.escape(category) : category.replace(/'/g, "\\'");
    document.querySelectorAll(".quarto-listing-category .category.active").forEach((el) => {
      el.classList.remove("active");
    });
    const chip = document.querySelector(
      `.quarto-listing-category .category[data-category='${safeCategory}']`
    );
    if (chip) chip.classList.add("active");
  };

  const showNoMatchMessages = () => {
    document.querySelectorAll(".quarto-listing").forEach((listing) => {
      const anyVisible = Array.from(listing.querySelectorAll(".list > li.project")).some(
        (item) => !item.classList.contains("d-none")
      );
      listing.querySelectorAll(".listing-no-matching").forEach((msg) => {
        msg.classList.toggle("d-none", anyVisible);
      });
    });
  };

  const hideViaListJs = (category) => {
    const registry = window["quarto-listings"];
    if (!registry || typeof registry !== "object") return false;
    const cat = category || "";
    Object.values(registry).forEach((list) => {
      if (!list) return;
      if (!cat) {
        list.filter();
        return;
      }
      list.filter((item) => {
        const cats = parseCategoryList(item?.values()?.categories || "");
        return cats.includes(cat);
      });
    });
    return true;
  };

  const domFilter = (category) => {
    const cat = category || "";
    items().forEach((item) => {
      const cats = parseCategoryList(item.dataset.categories || "");
      const show = !cat || cats.includes(cat);
      item.classList.toggle("d-none", !show);
    });
    showNoMatchMessages();
  };

  const applyCategory = (category) => {
    const cat = category || "";
    setActiveChip(cat);
    // Try list.js-backed filtering first; if unavailable, fall back to DOM toggling
    if (!hideViaListJs(cat)) {
      domFilter(cat);
    }
  };

  const categoryFromHash = () => {
    const match = window.location.hash.match(/category=([^&]*)/);
    return match ? decodeURIComponent(match[1]) : "";
  };

  const updateHash = (category) => {
    const url = new URL(window.location);
    url.hash = category ? `category=${encodeURIComponent(category)}` : "";
    window.history.replaceState(null, "", url);
  };

  const handleHashChange = () => applyCategory(categoryFromHash());

  const wireCategoryLinks = () => {
    // Inline badges
    document.querySelectorAll(".project-category a[href^='#category=']").forEach((link) => {
      link.addEventListener("click", (event) => {
        event.preventDefault();
        const raw = link.getAttribute("href").split("category=")[1] || "";
        const cat = decodeURIComponent(raw);
        updateHash(cat);
        applyCategory(cat);
      });
    });

    // Sidebar chips
    document.querySelectorAll(".quarto-listing-category .category").forEach((chip) => {
      chip.addEventListener("click", () => {
        const cat = chip.getAttribute("data-category") || "";
        updateHash(cat);
        applyCategory(cat);
      });
    });
  };

  const init = () => {
    if (!items().length) return;
    wireCategoryLinks();
    handleHashChange();
  };

  // Override Quarto hooks so any upstream calls use the resilient filter
  window.activateCategory = applyCategory;
  window.filterListingCategory = applyCategory;

  // When Quarto finishes wiring listings, re-apply the filter
  const originalLoaded = window["quarto-listing-loaded"];
  window["quarto-listing-loaded"] = () => {
    if (typeof originalLoaded === "function") {
      originalLoaded();
    }
    handleHashChange();
  };

  window.addEventListener("hashchange", handleHashChange);
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
